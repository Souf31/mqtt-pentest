# TLS Encryption

We will need to create our own self-signed certificates for this, but in a professional environment we will need ceritificates signed by a trusted third-party.

## Certificates

Have the **openssl** package installed

`sudo apt-get install openssl`

**CA Cert** : 

    openssl genrsa -out ca.key 2048 
    openssl req -new -x509 -days 365 -key ca.key -out ca.crt

**Serv Cert :** this certificate is the most important for this configuration

It needs to have differents informations than the one you chose for the CA certificate. 
More importantly, the IP of the broker needs to be in the CN and SAN fields. 

 - If you want to do it with your localhost, use **127.0.0.1**
 - Otherwise, use your local IP Address, mine is **192.168.129.2**

To do so:

    openssl genrsa -out server.key 2048
    openssl req -new -key server.key -out server.csr

**Remember to fill the CN with the IP address !**
```
openssl x509 -req -in server.csr \
        -extfile <(printf "subjectAltName=IP:127.0.0.1") \
        -CA ca.crt \
        -CAkey ca.key \
        -CAcreateserial -out server.crt \
        -days 365
```

**And here is the command for the SAN field of the server certificate.**

We will implement the TLS so the clients have to authenticate using a certificate. 

**To do so, we need to create a certificate for each clients.**

Here we will use one Paho client as both the publisher and subscriber, so we only need one certificate.

**Client cert**: 

    openssl genrsa -out client.key 2048
    openssl req -new -key client.key -out client.csr
    openssl x509 -req -days 365 -in client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out client.crt

Once the certificates are created, we need to edit the broker for it to support TLS. We will use docker-compose to run our docker.

## Docker configuration

Here is the structure of the mounted volume :

    ├── config
    
    │ ├── certs
    
    │ │ ├── ca.crt
    
    │ │ ├── server.crt
    
    │ │ └── server.key
    
    │ └── mosquitto.conf

Here is the **mosquitto.conf** file :

    port 8883
    
    cafile /mosquitto/config/certs/ca.crt
    
    certfile /mosquitto/config/certs/server.crt
    
    keyfile /mosquitto/config/certs/server.key
    
    require_certificate true
    
    use_identity_as_username true

TLS uses the port **8883** by default. 

We also put the certs files in the cert folder, but make sure the server.key file is **readable by the Mosquitto user**.

To do so, run this command: `chmod 644 ./config/certs/*`

Here is the docker-compose.yml file :

    version: '3.5'
    
    services:
    
    mosquitto:
    
    container_name: mosquitto_container
    
    image: eclipse-mosquitto:latest
    
    volumes:
    
    - ./config:/mosquitto/config/
    
    ports:
    
    - '8883:8883'
    
    networks:
    
    - default
    
    restart: unless-stopped
    
    networks:
    
    default:

To start the docker, we use the command docker-compose up.

## Client configuration

We again use the Paho library to communicate with the broker.

We create a new client tls.py. Here is the file : <insert file>

**The IP Address needs to be identical to the CN of the server certificate !**

We can see that we use TLS v1.2 with this line. <tls line>

Make sure that you can access the certificates from the python file : <cert files>

Connect to the client using `python3 tls.py`

## Traffic Inspection

Now if we want to inspect the traffic, we can use **Wireshark** again. 

![Image](https://media.discordapp.net/attachments/469531451696742410/1197227972319518720/image.png?ex=65ccf570&is=65ba8070&hm=0d61a83a09784ee9972857d0a4537844605e73b7aa63d31bb74dcb94555a3298&=&format=webp&quality=lossless&width=1440&height=233)

We can see that the traffic is using **TLSv1.2**. When we try to inspect it, we have no more information : ![Image](https://media.discordapp.net/attachments/469531451696742410/1197227648825430036/image.png?ex=65ccf522&is=65ba8022&hm=e442a6305420548cb3de9a248e0a4a9fbf0d0cfa05797ff893d0ddce417d6722&=&format=webp&quality=lossless&width=1098&height=600)

The traffic is now secured.
